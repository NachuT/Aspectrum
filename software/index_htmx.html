<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>High-Performance VR Camera</title>
    <link rel="stylesheet" href="style.css">
    <!-- HTMX for efficient DOM updates -->
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <!-- WebAssembly module for C++ color correction -->
    <script src="color_correction.js"></script>
</head>
<body>
    <div class="container">
        <div id="vrView" class="vr-view" 
             hx-post="/api/process-frame" 
             hx-trigger="click, touchstart" 
             hx-target="#status"
             hx-indicator="#loading">
            <div class="eye-view">
                <div class="left-eye">
                    <canvas id="leftCanvas" class="video-feed"></canvas>
                </div>
            </div>
            <div class="eye-view">
                <div class="right-eye">
                    <canvas id="rightCanvas" class="video-feed"></canvas>
                </div>
            </div>
        </div>
        
        <!-- Hidden video for camera capture -->
        <video id="cameraVideo" style="position: fixed; top: 10px; left: 10px; width: 2px; height: 1.5px; border: 2px solid red; z-index: 1001;" autoplay muted playsinline></video>
        
        <!-- Status and loading indicators -->
        <div id="status" class="status"></div>
        <div id="loading" class="loading hidden">
            <div class="spinner"></div>
            <p>Processing frame...</p>
        </div>
    </div>

    <script>
        class HighPerformanceVR {
            constructor() {
                this.cameraVideo = document.getElementById('cameraVideo');
                this.leftCanvas = document.getElementById('leftCanvas');
                this.rightCanvas = document.getElementById('rightCanvas');
                this.leftCtx = this.leftCanvas.getContext('2d', { willReadFrequently: true });
                this.rightCtx = this.rightCanvas.getContext('2d', { willReadFrequently: true });
                this.vrView = document.getElementById('vrView');
                
                this.stream = null;
                this.isRunning = false;
                this.lastFrameTime = 0;
                this.targetFPS = 30; // Higher FPS with C++ optimization
                
                // WebAssembly module
                this.wasmModule = null;
                this.processImageData = null;
                
                this.initWebAssembly();
                this.setupCanvas();
                this.initEventListeners();
                this.autoStart();
            }
            
            async initWebAssembly() {
                try {
                    console.log('üöÄ Loading WebAssembly module...');
                    this.wasmModule = await ColorCorrectionModule();
                    this.processImageData = this.wasmModule.cwrap('processImageData', null, ['number', 'number', 'number']);
                    console.log('‚úÖ WebAssembly module loaded successfully');
                } catch (error) {
                    console.error('‚ùå Failed to load WebAssembly module:', error);
                    // Fallback to JavaScript implementation
                    this.useWasm = false;
                }
            }
            
            setupCanvas() {
                this.leftCanvas.width = window.innerWidth / 2;
                this.leftCanvas.height = window.innerHeight;
                this.rightCanvas.width = window.innerWidth / 2;
                this.rightCanvas.height = window.innerHeight;
            }
            
            initEventListeners() {
                // HTMX will handle tap events
                console.log('üéØ HTMX event listeners configured');
                
                // Handle window resize
                window.addEventListener('resize', () => this.handleResize());
                
                // Handle page unload
                window.addEventListener('beforeunload', () => this.cleanup());
            }
            
            async autoStart() {
                await this.startCamera();
                this.startProcessing();
            }
            
            async startCamera() {
                try {
                    const constraints = {
                        video: {
                            width: { ideal: 1280 },
                            height: { ideal: 720 },
                            facingMode: 'environment'
                        }
                    };

                    this.stream = await navigator.mediaDevices.getUserMedia(constraints);
                    this.cameraVideo.srcObject = this.stream;
                    
                    this.cameraVideo.addEventListener('loadedmetadata', () => {
                        this.isRunning = true;
                        console.log('üìπ Camera started successfully');
                    });
                    
                } catch (err) {
                    console.error('‚ùå Camera error:', err);
                }
            }
            
            startProcessing() {
                const process = () => {
                    if (this.isRunning) {
                        this.processFrame();
                        requestAnimationFrame(process);
                    }
                };
                process();
            }
            
            processFrame() {
                if (this.cameraVideo.videoWidth === 0 || this.cameraVideo.videoHeight === 0) {
                    return;
                }
                
                // Frame rate limiting
                const now = performance.now();
                const timeSinceLastFrame = now - this.lastFrameTime;
                const targetFrameTime = 1000 / this.targetFPS;
                
                if (timeSinceLastFrame < targetFrameTime) {
                    return;
                }
                
                this.lastFrameTime = now;
                
                // Clear canvases
                this.leftCtx.clearRect(0, 0, this.leftCanvas.width, this.leftCanvas.height);
                this.rightCtx.clearRect(0, 0, this.rightCanvas.width, this.rightCanvas.height);
                
                if (this.wasmModule && this.processImageData) {
                    this.processFrameWithWasm();
                } else {
                    this.processFrameWithJS();
                }
            }
            
            processFrameWithWasm() {
                try {
                    // Draw original video to canvas
                    this.leftCtx.drawImage(this.cameraVideo, 0, 0, this.leftCanvas.width, this.leftCanvas.height);
                    
                    // Get image data
                    const imageData = this.leftCtx.getImageData(0, 0, this.leftCanvas.width, this.leftCanvas.height);
                    
                    // Process with WebAssembly (C++)
                    this.processImageData(
                        imageData.data.byteOffset + imageData.data.buffer.byteOffset,
                        this.leftCanvas.width,
                        this.leftCanvas.height
                    );
                    
                    // Put processed data back
                    this.leftCtx.putImageData(imageData, 0, 0);
                    
                    // Copy to right canvas
                    this.rightCtx.drawImage(this.leftCanvas, 0, 0);
                    
                } catch (error) {
                    console.error('‚ùå WebAssembly processing error:', error);
                    this.processFrameWithJS();
                }
            }
            
            processFrameWithJS() {
                // Fallback to JavaScript implementation
                this.leftCtx.drawImage(this.cameraVideo, 0, 0, this.leftCanvas.width, this.leftCanvas.height);
                this.rightCtx.drawImage(this.cameraVideo, 0, 0, this.rightCanvas.width, this.rightCanvas.height);
            }
            
            handleResize() {
                this.setupCanvas();
            }
            
            cleanup() {
                if (this.stream) {
                    this.stream.getTracks().forEach(track => track.stop());
                    this.stream = null;
                }
                this.isRunning = false;
            }
        }
        
        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', () => {
            new HighPerformanceVR();
        });
        
        // HTMX event handlers
        document.body.addEventListener('htmx:beforeRequest', function(evt) {
            console.log('üì§ HTMX request starting...');
        });
        
        document.body.addEventListener('htmx:afterRequest', function(evt) {
            console.log('üì• HTMX request completed');
        });
        
        document.body.addEventListener('htmx:responseError', function(evt) {
            console.error('‚ùå HTMX request failed:', evt.detail);
        });
    </script>
</body>
</html>
